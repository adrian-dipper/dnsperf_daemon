# DNS Performance Daemon

**Languages:** English (this document) | [Deutsch](README.md)

> Changelog / Release History: see [CHANGELOG](CHANGELOG.md)

## ⚠️ Disclaimer: Enterprise-Grade Overkill Warning

Yes, I'm fully aware that this project – for something as trivial as "measure DNS latency every 30 seconds" – is about as excessive as taking a battle tank to buy bread.

**What began as a 10‑line Bash loop was deliberately inflated into a pseudo‑enterprise daemon with the following "essential" features:**

- Graceful shutdown via signal handlers (SIGTERM / SIGINT cleanly caught)
- Configuration reload via SIGHUP (no restart)
- Child process tracking & enforced termination (dnsperf, wget, unzip, etc.)
- Interruptible, signal-aware sleep (fine‑grained and breakable)
- Defensive error handling
- Structured, multi-line logging with timestamps
- Test harness for core paths & regressions
- Only the latest result is persisted (no historical clutter)
- Daily domain refresh (Top‑N from Cisco Umbrella + static list)
- OpenRC integration (start / stop / restart / reload / status)

*The real reason?* Pure curiosity and a bit of engineering ambition: layer by layer, a small base script was expanded through intentional, narrowly scoped feature prompting (reload, cleaner shutdown, child kill logic, logging expansion, tests ...). Not a fuzzy *"make it professional"*, but iterative *"Can we add X? Then also Y."* Minimal curation – the AI built most of it.

**The result:** A daemon arguably more stable than some production services – performing a task that could also be replaced with:
```
while true; do dig +stats google.com @1.1.1.1 > /dev/null; sleep 30; done
```
But where’s the fun in that?

### 🤖 AI-Generated Code Notice
Most of this code was generated by AI. Manual edits were minimal, and most of *those* were also implemented through further AI prompting. This repository is intentionally an experiment in AI-assisted incremental engineering.

**Models involved:**
- Claude 4.0 Sonnet (Anthropic) – primary generation & refactors
- Gemini 2.5 Pro (Google) – enhancement & polishing passes
- GPT-5 (OpenAI) – reasoning support & documentation shaping
- GitHub Copilot – inline completions & micro-adjustments

Sometimes you build it simply to prove you can – not because you should.

---

An OpenRC-compatible daemon that periodically measures DNS performance by resolving a curated list of domains and storing only the latest latency result.

## Features
- Periodic DNS performance measurement (default interval: 30s)
- Daily refresh of Top N (default 1000) domains from Cisco Umbrella list
- Merge of static host list + dynamic daily list
- Only latest average latency persisted (no growing state)
- Structured logging into a dedicated log file
- Live configuration reload (SIGHUP)
- Child process supervision & forced termination with timeout
- OpenRC integration (start / stop / restart / reload / status)

## Quick Start
```bash
sudo ./install.sh
sudo rc-service dnsperf_daemon start
rc-service dnsperf_daemon status
cat /var/lib/dnsperf_daemon/latest_result.txt
```

## Requirements
- OpenRC init system
- `dnsperf`
- `wget`
- `unzip`
- Root privileges for installation / service management

### Install dependencies (Gentoo / Alpine)
```bash
# Gentoo
emerge -av net-dns/bind-tools net-misc/wget app-arch/unzip

# Alpine
apk add bind-tools wget unzip
```
(`dnsperf` may need to be built from source depending on distro availability.)

## Installation
```bash
chmod +x install.sh
sudo ./install.sh
```
This script installs the daemon script, OpenRC init file, config template and creates required directories.

### Manual Installation
```bash
cp bin/dns_perf_backend.sh /usr/local/bin/
chmod +x /usr/local/bin/dns_perf_backend.sh
cp init/dnsperf_daemon /etc/init.d/
chmod +x /etc/init.d/dnsperf_daemon
rc-update add dnsperf_daemon default
```

## Service Usage
```bash
rc-service dnsperf_daemon start
rc-service dnsperf_daemon status
rc-service dnsperf_daemon stop
rc-service dnsperf_daemon restart
rc-service dnsperf_daemon reload
```

## Configuration (`/etc/dnsperf_daemon.conf`)
```bash
# Interval between test cycles (seconds)
SLEEP_INTERVAL=30

# Target DNS server
DNS_SERVER="1.1.1.1"

# Maximum number of concurrent DNS queries
MAX_OUTSTANDING_QUERIES=20

# Domain list source (Cisco Umbrella Top 1M)
URL="http://s3-us-west-1.amazonaws.com/umbrella-static/top-1m.csv.zip"
DOMAIN_COUNT=1000

# Static domains appended before dynamic list
STATIC_HOSTS=(
  "google.de"
  "youtube.com"
  # add more if needed
)
```
Apply changes without restart:
```bash
rc-service dnsperf_daemon reload
```

## Directory & Files
| Purpose | Path |
|---------|------|
| Script | /usr/local/bin/dns_perf_backend.sh |
| Config | /etc/dnsperf_daemon.conf |
| Init Script | /etc/init.d/dnsperf_daemon |
| PID File | /var/run/dnsperf_daemon.pid |
| Log File | /var/log/dnsperf_daemon.log |
| Working Dir | /var/lib/dnsperf_daemon/ |
| Latest Result | /var/lib/dnsperf_daemon/latest_result.txt |
| Cached Domains | /var/lib/dnsperf_daemon/top_domains.txt |

## Makefile Targets
```bash
make help
make install
make start
make status
make result
make test
make test-results
```

## Testing
A backend test harness is included:
```bash
./bin/test_dns_perf_backend.sh
# or
make test
```
**Test mode characteristics:**
- Reduced domain count (faster execution)
- Isolated temporary workspace
- Result archival by commit + timestamp
- Automatic cleanup
- Validates core paths (config load, host update, dnsperf invocation, integration)

## Monitoring
```bash
tail -f /var/log/dnsperf_daemon.log
cat /var/lib/dnsperf_daemon/latest_result.txt
rc-service dnsperf_daemon status
```

## Troubleshooting
| Symptom | Suggestion |
|---------|------------|
| No result file | Check log, verify dnsperf installed |
| High CPU usage | Lower MAX_OUTSTANDING_QUERIES or raise SLEEP_INTERVAL |
| Slow / stuck stop | Inspect log: hanging child (dnsperf / wget)? |
| Reload has no effect | Confirm SIGHUP sent to correct PID (check pidfile) |
| Domains not updating | Check date rollover & write permissions in work dir |

### Sanity Checks
```bash
which dnsperf wget unzip
nslookup google.de 1.1.1.1
```

## Uninstall
```bash
rc-service dnsperf_daemon stop
rc-update del dnsperf_daemon default
rm /etc/init.d/dnsperf_daemon
rm /usr/local/bin/dns_perf_backend.sh
rm -rf /var/lib/dnsperf_daemon
rm /var/log/dnsperf_daemon.log
rm /var/run/dnsperf_daemon.pid
```

## Sample Result
```
12.345678
```
Represents average latency in seconds (6 decimal places → microsecond-style precision). Full context in the log file.

## Contribution

Contributions are welcome. Please follow these conventions:

- Commit format (Conventional Commits):
  - `feat: ...`, `fix: ...`, `docs: ...`, `refactor: ...`, `test: ...`, `ci: ...`, `chore: ...`, `perf: ...`, `style: ...`, `build: ...`, `revert: ...`, `security: ...`
  - Optional scope: `feat(logging): ...`
  - Breaking change: `feat(api)!: ...` + footer `BREAKING CHANGE: <explanation>`
  - Source of truth for allowed types & regex: `scripts/conventional_commits.sh` (run with `--regex` to print pattern)
- Changelog requirement: Any non‑documentation change must update `CHANGELOG.md`.
- Bilingual rule: If you change *one* README, update the other (English + German) in the same PR.
- Exceptions:
  - Pure documentation / CI changes: changelog not required
  - Force skip (use sparingly): include `[skip-changelog]` in commit body
  - Skip commit format check (rare / exceptional): include `[skip-conventional-check]` in commit body
    - Acceptable cases: upstream merge commits you cannot reword, bulk mechanical refactors, auto-generated version bumps
    - Not acceptable: normal feature, fix, refactor or docs commits (reword instead)
    - Always prefer interactive rebase / squash over skipping
- Validation:
  - PR workflow enforces commit format & changelog presence
  - Non‑conforming commits block merge unless explicitly skipped

Examples:
```
feat(process): add child process supervision with forced termination timeout
fix(reload): rebuild host list after config change
docs(readme): sync English and German contribution sections
```
Skip examples (not recommended):
```
chore: update formatting

[skip-changelog]
```
```
chore: vendor upstream merge

[skip-conventional-check]
```

## License
MIT License – see `LICENSE`.

---
If you're reading this wondering "Why?" – the answer is: *Because iterative prompting plus curiosity tends to snowball.*
